# ===================================================
# images
# ===================================================

image=dind-buildx:
  image: jdrouet/docker-with-buildx
  pull: once
  tags:
    - stable

image=qemu-user-static:
  image: tonistiigi/binfmt
  pull: once
  tags:
    - latest

# ===================================================
# jobs
# ===================================================

job=install-qemu-user-static:
  use: qemu-user-static
  command: "--install all"
  privileged: true
  annotations:
    description: "\t-> installs qemu-user-static for multiarch builds"


job=uninstall-qemu-user-static:
  use: qemu-user-static
  command: "--uninstall qemu-aarch64,qemu-arm,qemu-mips64,qemu-mips64el,qemu-ppc64le,qemu-riscv64,qemu-s390x"
  privileged: true
  annotations:
    description: "\t-> uninstalls qemu-user-static"


job=check-qemu-user-static:
  use: qemu-user-static
  privileged: true
  annotations:
    description: "\t-> checks the qemu-user-static installation"


job=build-and-push-demo-image:
  use: dind-buildx
  depends: [install-qemu-user-static]
  provide-docker: true
  mounts:
    - mount-src
    - mount-docker-config
  interactive: true
  command: sh -c "cd /src;
           name=$(docker buildx create --use);
           docker buildx build --push --platform linux/arm64,linux/amd64 --tag ${DOCKER_REGISTRY}/gps-to-ads-app:${VERSION} .;
           docker kill buildx_buildkit_${name}0;
           docker rm buildx_buildkit_${name}0"
  env:
   - DOCKER_DRIVER=overlay2
   - VERSION={env.GitVersion_ShortSha}
   - DOCKER_REGISTRY={env.DOCKER_REGISTRY}
  annotations:
    description: "\t-> builds and pushes demo docker images"
